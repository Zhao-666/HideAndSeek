<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HideAndSeek</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <link rel="icon" href="data:;base64,=">
    <style>
        .gameItem {
            display: inline-block;
            width: 100px;
            height: 100px;
            line-height: 100px;
            border: 1px solid black;
        }

        .wall {
            background-color: black;
        }

        .road {
            color: white;
        }

        .player {
            text-align: center;
        }
    </style>
</head>
<body>

<div id="app">
    <label>
        玩家ID：
        <input type="text" :value="playerId">
    </label>
    <button @click="matchPlayer">匹配</button>
    <div v-if="matching" style="display: inline">
        匹配中……
    </div>
    <div v-if="roomId">
        房间号：{{roomId}}
    </div>
    <br>
    <hr>
    <div v-if="mapData">
        <template v-for="column in mapData">
            <div>
                <template v-for="item in column">
                    <div v-if="item==playerId" class="gameItem player"><span>{{playerId}}</span></div>
                    <div v-else-if="item==0" class="gameItem wall">墙</div>
                    <div v-else-if="item==1" class="gameItem road">路</div>
                </template>
            </div>
        </template>
    </div>
</div>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            websock: null,
            playerId: 'player_' + Math.round(Math.random() * 1000),
            matching: false,
            roomId: '',
            mapData: [],
        },
        created() {
            this.initWebSocket();
        },
        destroyed() {
            this.websock.close() //离开路由之后断开websocket连接
        },
        methods: {
            //匹配玩家
            matchPlayer() {
                let actions = {"code": 600};
                this.websocketsend(actions);
                this.matching = true
            },
            startRoom() {
                let actions = {"code": 601, 'room_id': this.roomId};
                this.websocketsend(actions);
                this.matching = false
            },
            initWebSocket() { //初始化weosocket
                const wsuri = "ws://192.168.56.101:8811?player_id=" + this.playerId;
                this.websock = new WebSocket(wsuri);
                this.websock.onmessage = this.websocketonmessage;
                this.websock.onopen = this.websocketonopen;
                this.websock.onerror = this.websocketonerror;
                this.websock.onclose = this.websocketclose;
            },
            websocketonopen() { //连接建立之后执行send方法发送数据
            },
            websocketonerror() {//连接建立失败重连
                this.initWebSocket();
            },
            websocketonmessage(e) { //数据接收
                let message = JSON.parse(e.data);
                let responseData = message.data
                switch (message.code) {
                    case 1001://匹配成功
                        this.roomId = responseData.room_id
                        this.startRoom()
                        break;
                    case 1004://游戏数据
                        this.mapData = responseData.map_data;
                        break;
                }
            },
            websocketsend(Data) {//数据发送
                this.websock.send(JSON.stringify(Data));
            },
            websocketclose(e) {  //关闭
                console.log('断开连接', e);
            },
        }
    })
</script>
</body>
</html>